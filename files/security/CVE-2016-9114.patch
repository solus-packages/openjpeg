From de42fd16c5cacfc76c45771632946cffd3e8a3ec Mon Sep 17 00:00:00 2001
From: Pierre-Yves <pyu@riseup.net>
Date: Thu, 10 Aug 2017 13:25:42 +0200
Subject: [PATCH] CVE-2016-9114

Signed-off-by: Pierre-Yves <pyu@riseup.net>
---
 src/bin/jp2/convert.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/bin/jp2/convert.c b/src/bin/jp2/convert.c
index e2e1602..86743de 100644
--- a/src/bin/jp2/convert.c
+++ b/src/bin/jp2/convert.c
@@ -2137,7 +2137,7 @@ int imagetopnm(opj_image_t * image, const char *outfile, int force_split)
         adjustR =
             (image->comps[compno].sgnd ? 1 << (image->comps[compno].prec - 1) : 0);
 
-        if (prec > 8) {
+        if (prec > 8 && red) {
             for (i = 0; i < wr * hr; i++) {
                 v = *red + adjustR;
                 ++red;
@@ -2162,7 +2162,7 @@ int imagetopnm(opj_image_t * image, const char *outfile, int force_split)
                     fprintf(fdest, "%c%c", (unsigned char)(v >> 8), (unsigned char)v);
                 }
             }/* for(i */
-        } else { /* prec <= 8 */
+        } else if (red) { /* prec <= 8 */
             for (i = 0; i < wr * hr; ++i) {
                 v = *red + adjustR;
                 ++red;
-- 
2.13.4

