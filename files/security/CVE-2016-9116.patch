From cbe538264135d9612b091ac640e0b753d799322b Mon Sep 17 00:00:00 2001
From: Pierre-Yves <pyu@riseup.net>
Date: Thu, 10 Aug 2017 11:56:45 +0200
Subject: [PATCH] CVE-2016-9116

Signed-off-by: Pierre-Yves <pyu@riseup.net>
---
 src/bin/jp2/convert.c | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/src/bin/jp2/convert.c b/src/bin/jp2/convert.c
index fdc2937..138485b 100644
--- a/src/bin/jp2/convert.c
+++ b/src/bin/jp2/convert.c
@@ -2405,6 +2405,11 @@ static int imagetoraw_common(opj_image_t * image, const char *outfile,
             if (image->comps[compno].sgnd == 1) {
                 mask = (1 << image->comps[compno].prec) - 1;
                 ptr = image->comps[compno].data;
+                if (!ptr) {
+                    fprintf (stderr, "Missing image component data for %s\n", outfile);
+                    goto fin;
+                }
+
                 for (line = 0; line < h; line++) {
                     for (row = 0; row < w; row++)    {
                         curr = *ptr;
@@ -2425,6 +2430,11 @@ static int imagetoraw_common(opj_image_t * image, const char *outfile,
             } else if (image->comps[compno].sgnd == 0) {
                 mask = (1 << image->comps[compno].prec) - 1;
                 ptr = image->comps[compno].data;
+                if (!ptr) {
+                    fprintf (stderr, "Missing image component data for %s\n", outfile);
+                    goto fin;
+                }
+
                 for (line = 0; line < h; line++) {
                     for (row = 0; row < w; row++)    {
                         curr = *ptr;
@@ -2451,6 +2461,11 @@ static int imagetoraw_common(opj_image_t * image, const char *outfile,
                 } uc16;
                 mask = (1 << image->comps[compno].prec) - 1;
                 ptr = image->comps[compno].data;
+                if (!ptr) {
+                    fprintf (stderr, "Missing image component data for %s\n", outfile);
+                    goto fin;
+                }
+
                 for (line = 0; line < h; line++) {
                     for (row = 0; row < w; row++)    {
                         curr = *ptr;
@@ -2475,6 +2490,11 @@ static int imagetoraw_common(opj_image_t * image, const char *outfile,
                 } uc16;
                 mask = (1 << image->comps[compno].prec) - 1;
                 ptr = image->comps[compno].data;
+                if (!ptr) {
+                    fprintf (stderr, "Missing image component data for %s\n", outfile);
+                    goto fin;
+                }
+
                 for (line = 0; line < h; line++) {
                     for (row = 0; row < w; row++)    {
                         curr = *ptr;
-- 
2.13.4

